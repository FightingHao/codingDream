import { LogicCommmand } from './logic'
import { InternalSymbol, SYMBOL_UNSET_FIELD_NAME, SYMBOL_QUERY_COMMAND } from '../helper/symbol'
import { assertType } from 'utils/assert'

// types
import { DB } from 'typings'

export const EQ = 'eq'
export const NEQ = 'neq'
export const GT = 'gt'
export const GTE = 'gte'
export const LT = 'lt'
export const LTE = 'lte'
export const IN = 'in'
export const NIN = 'nin'

export enum QUERY_COMMANDS_LITERAL {
  EQ = 'eq',
  NEQ = 'neq',
  GT = 'gt',
  GTE = 'gte',
  LT = 'lt',
  LTE = 'lte',
  IN = 'in',
  NIN = 'nin',
}

export class QueryCommmand extends LogicCommmand implements DB.DatabaseQueryCommand {

  public operator: QUERY_COMMANDS_LITERAL

  constructor(operator: QUERY_COMMANDS_LITERAL, operands: any[], fieldName?: string | InternalSymbol) {
    super(operator, operands, fieldName)
    this.operator = operator
    this._internalType = SYMBOL_QUERY_COMMAND
  }

  _setFieldName(fieldName: string): DB.DatabaseQueryCommand {
    const command = new QueryCommmand(this.operator, this.operands, fieldName)
    return command
  }

  eq(val: any) {
    const command = new QueryCommmand(QUERY_COMMANDS_LITERAL.EQ, [val], this.fieldName)
    return this.and(command)
  }
  
  neq(val: any) {
    const command = new QueryCommmand(QUERY_COMMANDS_LITERAL.NEQ, [val], this.fieldName)
    return this.and(command)
  }
  
  gt(val: any) {
    const command = new QueryCommmand(QUERY_COMMANDS_LITERAL.GT, [val], this.fieldName)
    return this.and(command)
  }
  
  gte(val: any) {
    const command = new QueryCommmand(QUERY_COMMANDS_LITERAL.GTE, [val], this.fieldName)
    return this.and(command)
  }
  
  lt(val: any) {
    const command = new QueryCommmand(QUERY_COMMANDS_LITERAL.LT, [val], this.fieldName)
    return this.and(command)
  }
  
  lte(val: any) {
    const command = new QueryCommmand(QUERY_COMMANDS_LITERAL.LTE, [val], this.fieldName)
    return this.and(command)
  }
  
  in(list: any[]) {
    assertType(list, 'array')
    const command = new QueryCommmand(QUERY_COMMANDS_LITERAL.IN, list, this.fieldName)
    return this.and(command)
  }

  nin(list: any[]) {
    assertType(list, 'array')
    const command = new QueryCommmand(QUERY_COMMANDS_LITERAL.NIN, list, this.fieldName)
    return this.and(command)
  }
}

export function isQueryCommand(object: any): object is QueryCommmand {
  return object && (object instanceof QueryCommmand) && (object._internalType === SYMBOL_QUERY_COMMAND)
}

export function isKnownQueryCommand(object: any): object is QueryCommmand {
  return isQueryCommand(object) && (object.operator.toUpperCase() in QUERY_COMMANDS_LITERAL)
}

export function isComparisonCommand(object: any): object is QueryCommmand {
  return isQueryCommand(object)
}

export default QueryCommmand
